@using Uploadify.Client.Domain.Resources.Models
@using Uploadify.Client.Application.FileSystem.Services
@using Uploadify.Client.Application.FileSystem.Helpers
@using Uploadify.Client.Application.FileSystem.Models
@attribute [Permission]
@attribute [Route(PageRoutes.Homepage)]

@inject FolderService FolderService
@inject IStringLocalizer<TranslationDictionary> Localizer

<PageTitle>@Localizer[Translations.Pages.Dashboard.Title]</PageTitle>
<MudText Typo="Typo.h1">@Localizer[Translations.Pages.Dashboard.Title]</MudText>
<MudText Class="mt-4 mb-8"
         Typo="Typo.body1">
    Text text text
</MudText>

<MudText Typo="Typo.h3">Nahrát soubory</MudText>
<MudFileUpload Hidden="@false"
               InputClass="absolute mud-width-full mud-height-full overflow-hidden z-20"
               InputStyle="opacity:0"
               @ondragend="@ClearDragClass"
               @ondragenter="@SetDragClass"
               @ondragleave="@ClearDragClass"
               T="IReadOnlyList<IBrowserFile>">
    <ButtonTemplate>
        <MudPaper Class="@DragFileInputClass"
                  Outlined="true">
            <MudStack AlignItems="AlignItems.Center"
                      Justify="Justify.Center"
                      Row
                      Style="height: 50px;">
                <MudText>
                    Přetáhněte zde soubory
                </MudText>
            </MudStack>
        </MudPaper>
        <MudToolBar Class="relative d-flex justify-end gap-4 z-30"
                    Dense="true"
                    DisableGutters="true">
            <MudButton Color="Color.Primary"
                       for="@context.Id"
                       HtmlTag="label"
                       Size="Size.Small"
                       Variant="Variant.Text">
                Nahrát soubory
            </MudButton>
            <MudButton Color="Color.Primary"
                       Size="Size.Small"
                       Variant="Variant.Text">
                Odeslat
            </MudButton>
            <MudButton Color="Color.Primary"
                       Size="Size.Small"
                       Variant="Variant.Text">
                Zrušit
            </MudButton>
        </MudToolBar>
    </ButtonTemplate>
</MudFileUpload>

<MudText Typo="Typo.h3" Class="mb-5">Přehled</MudText>
@if (_isLoading)
{
    <MudSkeleton Animation="Animation.Pulse"
                 Height="500px"
                 SkeletonType="SkeletonType.Rectangle"
                 Width="100%"/>
}

@if (!_isLoading && _resourceResponse is { IsSuccess: true })
{
    <MudDataGrid Bordered="false"
                 Filterable="false"
                 Groupable="false"
                 Hover
                 Items="FolderHelpers.GetDashboardItems(_resourceResponse)"
                 Outlined="false"
                 ReadOnly
                 Dense
                 T="DashboardItem">
        <Columns>
            <TemplateColumn ShowColumnOptions="false"
                            SortBy="item => item.Name"
                            Title="Název souboru">
                <CellTemplate>
                    <MudStack AlignItems="AlignItems.Center"
                              Justify="Justify.SpaceBetween"
                              Row
                              Spacing="2">
                        <MudStack AlignItems="AlignItems.Center"
                                  Row
                                  Spacing="2">
                            @if (context.Item.IsFolder)
                            {
                                <MudIcon Icon="@Icons.Material.Rounded.Folder"></MudIcon>
                            }
                            else
                            {
                                <MudIcon Icon="@Icons.Material.Rounded.InsertDriveFile"></MudIcon>
                            }

                            <MudText>@FolderHelpers.GetShortFileName(context.Item)</MudText>
                        </MudStack>
                        <MudMenu Disabled="context.Item.IsRootFolder">
                            <ActivatorContent>
                                <MudIconButton Icon="@Icons.Material.Rounded.MoreVert"/>
                            </ActivatorContent>
                            <ChildContent>
                                <MudMenuItem Icon="@Icons.Material.Rounded.PersonAdd">Sdílet</MudMenuItem>
                                <MudMenuItem Icon="@Icons.Material.Rounded.FileDownload">Stáhnout</MudMenuItem>
                                <MudMenuItem Icon="@Icons.Material.Rounded.DriveFileMove">Přesunout</MudMenuItem>
                                <MudMenuItem Icon="@Icons.Material.Rounded.DriveFileRenameOutline">
                                    <MudText>Přejmenovat</MudText>
                                </MudMenuItem>
                                <MudMenuItem Icon="@Icons.Material.Rounded.Delete">Přesunout do koše</MudMenuItem>
                            </ChildContent>
                        </MudMenu>
                    </MudStack>
                </CellTemplate>
            </TemplateColumn>
        </Columns>
    </MudDataGrid>
}

@code {
    private ResourceResponse<FolderSummary>? _resourceResponse;
    private bool _isLoading = true;
    private readonly CancellationTokenSource _cancellationTokenSource = new();

    protected override async Task OnInitializedAsync()
    {
        _resourceResponse = await FolderService.GetSummary(_cancellationTokenSource.Token);
        _isLoading = false;
    }

    private const string DefaultDragFileInputClass = "relative rounded-lg border-2 border-dashed pa-4 mt-4 mud-width-full mud-height-full z-10";
    private string DragFileInputClass = DefaultDragFileInputClass;

    private void SetDragClass()
    {
        DragFileInputClass = $"{DefaultDragFileInputClass} mud-border-primary";
    }

    private void ClearDragClass()
    {
        DragFileInputClass = DefaultDragFileInputClass;
    }

}
